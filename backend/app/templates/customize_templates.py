"""
===================================================================================
 EMinder - è‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿
===================================================================================

 æ¬¢è¿æ¥åˆ° EMinder çš„æ¨¡æ¿å®šåˆ¶ä¸­å¿ƒï¼
 åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œåˆ›å»ºä¸ªæ€§åŒ–çš„é‚®ä»¶æ¨¡æ¿ã€‚æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼Œå³å¯è½»æ¾æ‰©å±• EMinder çš„åŠŸèƒ½ã€‚

 --- å¦‚ä½•æ“ä½œ ---

 1. å®šä¹‰æ¨¡æ¿å…ƒæ•°æ® (Metadata):
    - æ¯ä¸ªæ¨¡æ¿éƒ½éœ€è¦ä¸€ä¸ªâ€œå…ƒæ•°æ®â€å­—å…¸ï¼Œå®ƒå‘Šè¯‰å‰ç«¯ç•Œé¢å¦‚ä½•å±•ç¤ºè¿™ä¸ªæ¨¡æ¿çš„è¾“å…¥å­—æ®µã€‚
    - ç»“æ„:
      {
          "display_name": "æ¨¡æ¿åœ¨UIä¸Šæ˜¾ç¤ºçš„åç§°",
          "description": "ä¸€æ®µæè¿°ï¼Œè§£é‡Šè¿™ä¸ªæ¨¡æ¿çš„ç”¨é€”",
          "fields": [
              {
                  "name": "å­—æ®µçš„å†…éƒ¨å˜é‡å (è‹±æ–‡)",
                  "label": "åœ¨UIä¸Šæ˜¾ç¤ºçš„æ ‡ç­¾ (ä¸­æ–‡/è‹±æ–‡)",
                  "type": "å­—æ®µç±»å‹ï¼Œæ”¯æŒ 'text', 'textarea', 'number'",
                  "default": "è¯¥å­—æ®µçš„é»˜è®¤å€¼"
              },
              // ... å¯ä»¥æ·»åŠ æ›´å¤šå­—æ®µ
          ]
      }

 2. ç¼–å†™æ¨¡æ¿ç”Ÿæˆå‡½æ•° (Template Function):
    - æ¯ä¸ªæ¨¡æ¿éƒ½éœ€è¦ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ¥æ”¶ç”¨æˆ·åœ¨å‰ç«¯å¡«å†™çš„æ•°æ®ï¼Œå¹¶ç”Ÿæˆæœ€ç»ˆçš„é‚®ä»¶ HTML å†…å®¹ã€‚
    - å‡½æ•°å¿…é¡»æ¥æ”¶ä¸€ä¸ªåä¸º `data` çš„å­—å…¸ä½œä¸ºå‚æ•°ã€‚
    - å‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å« `subject` (é‚®ä»¶ä¸»é¢˜) å’Œ `html` (é‚®ä»¶å†…å®¹)ã€‚

 3. æ³¨å†Œä½ çš„æ¨¡æ¿:
    - å°†ä½ åˆ›å»ºçš„å…ƒæ•°æ®å­—å…¸å’Œæ¨¡æ¿ç”Ÿæˆå‡½æ•°ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„æ¨¡æ¿ä¿¡æ¯ã€‚
    - å°†è¿™ä¸ªæ¨¡æ¿ä¿¡æ¯æ·»åŠ åˆ°ä¸€ä¸ªåä¸º `custom_templates` çš„å­—å…¸ä¸­ï¼Œkey ä¸ºæ¨¡æ¿çš„å”¯ä¸€æ ‡è¯†ç¬¦ (é€šå¸¸æ˜¯å…ƒæ•°æ®ä¸­ `name` çš„è›‡å½¢å‘½åæ³•)ã€‚

 4. å¯ç”¨æ¨¡æ¿:
    - **æœ€é‡è¦çš„ä¸€æ­¥**: å‰å¾€ `email_templates.py` æ–‡ä»¶ã€‚
    - å–æ¶ˆå¯¹ `from .customize_templates import custom_templates` çš„æ³¨é‡Šã€‚
    - ç¨‹åºä¼šè‡ªåŠ¨å°†ä½ åœ¨è¿™é‡Œå®šä¹‰çš„æ‰€æœ‰æ¨¡æ¿åˆå¹¶åˆ°ä¸»æ¨¡æ¿ç®¡ç†å™¨ä¸­ã€‚

 --- ç¤ºä¾‹ ---

 ä¸‹é¢æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„â€œæœˆåº¦å­¦ä¹ æŠ¥å‘Šâ€æ¨¡æ¿ä½œä¸ºå‚è€ƒã€‚ä½ å¯ä»¥å¤åˆ¶ã€ä¿®æ”¹æˆ–åŸºäºå®ƒåˆ›å»ºå…¨æ–°çš„æ¨¡æ¿ã€‚
"""

# ===================================================================================
# ç¤ºä¾‹æ¨¡æ¿ 1: æœˆåº¦å­¦ä¹ æŠ¥å‘Š (Monthly Learning Report)
# ===================================================================================

# --- æ­¥éª¤ 1: å®šä¹‰å…ƒæ•°æ® ---
monthly_learning_report_meta = {
    "display_name": "æœˆåº¦å­¦ä¹ æŠ¥å‘Š",
    "description": "ä¸ºå­¦ç”Ÿæˆ–å›¢é˜Ÿæˆå‘˜ç”Ÿæˆæœˆåº¦å­¦ä¹ è¿›å±•æŠ¥å‘Šã€‚",
    "fields": [
        {
            "name": "student_name",
            "label": "å­¦ç”Ÿå§“å",
            "type": "text",
            "default": "å°æ˜"
        },
        {
            "name": "courses_completed",
            "label": "æœ¬æœˆå®Œæˆè¯¾ç¨‹ (ç”¨è‹±æ–‡é€—å·,åˆ†éš”)",
            "type": "textarea",
            "default": "Python è¿›é˜¶, æ•°æ®åº“åŸç†"
        },
        {
            "name": "total_hours",
            "label": "æœ¬æœˆæ€»å­¦ä¹ æ—¶é•¿ (å°æ—¶)",
            "type": "number",
            "default": 40
        },
        {
            "name": "next_month_goals",
            "label": "ä¸‹æœˆå­¦ä¹ ç›®æ ‡ (ç”¨è‹±æ–‡é€—å·,åˆ†éš”)",
            "type": "textarea",
            "default": "å®Œæˆæœºå™¨å­¦ä¹ é¡¹ç›®, å­¦ä¹  Docker"
        }
    ]
}

# --- æ­¥éª¤ 2: ç¼–å†™æ¨¡æ¿ç”Ÿæˆå‡½æ•° ---
def get_monthly_learning_report_template(data: dict) -> dict:
    """ç”Ÿæˆæœˆåº¦å­¦ä¹ æŠ¥å‘Šçš„é‚®ä»¶å†…å®¹"""
    subject = f"ã€å­¦ä¹ æŠ¥å‘Šã€‘{data.get('student_name', 'åŒå­¦')} çš„æœˆåº¦å­¦ä¹ æŠ¥å‘Š"
    completed_courses_str = str(data.get("courses_completed", ""))
    next_month_goals_str = str(data.get("next_month_goals", ""))
    # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º HTML åˆ—è¡¨
    completed_courses_html = "<ul>" + "".join(
        [f"<li>{course.strip()}</li>" for course in completed_courses_str.split(',') if course.strip()]
    ) + "</ul>"
    
    next_month_goals_html = "<ul>" + "".join(
        [f"<li>{goal.strip()}</li>" for goal in next_month_goals_str.split(',') if goal.strip()]
    ) + "</ul>"

    # ä½¿ç”¨ f-string æ„å»ºé‚®ä»¶ä¸»ä½“å†…å®¹
    # æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰è°ƒç”¨ get_base_htmlï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæ–‡ä»¶æ˜¯ç‹¬ç«‹çš„ã€‚
    # åœ¨å®é™…åˆå¹¶æ—¶ï¼ŒTemplateManager ä¼šè‡ªåŠ¨ä¸ºå®ƒåŒ…è£¹ä¸Šæ¼‚äº®çš„æ ·å¼ã€‚
    content = f"""
        <p>ä½ å¥½, <strong>{data.get('student_name', 'åŒå­¦')}</strong>ï¼</p>
        <p>è¿™æ˜¯ä½ æœ¬æœˆçš„å­¦ä¹ è¿›å±•æ€»ç»“ï¼Œè¯·æŸ¥æ”¶ï¼š</p>
        
        <h4>æœ¬æœˆæˆå°± ğŸ†</h4>
        <p>ä½ æœ¬æœˆå…±æŠ•å…¥äº† <strong>{data.get('total_hours', 0)}</strong> å°æ—¶ç”¨äºå­¦ä¹ ï¼Œå–å¾—äº†å¾ˆæ£’çš„æˆæœï¼</p>
        
        <h4>å®Œæˆçš„è¯¾ç¨‹:</h4>
        {completed_courses_html if completed_courses_str.strip() else "<p>æœ¬æœˆæš‚æ— å®Œæˆè¯¾ç¨‹è®°å½•ã€‚</p>"}
        
        <h4>ä¸‹æœˆç›®æ ‡ ğŸš€</h4>
        <p>è¯·ç»§ç»­ä¿æŒåŠ¿å¤´ï¼Œå‘ç€ä»¥ä¸‹ç›®æ ‡å‰è¿›ï¼š</p>
        {next_month_goals_html if next_month_goals_str.strip() else "<p>ä¸‹æœˆç›®æ ‡å¾…å®šã€‚</p>"}
        
        <p>â€œä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸã€‚â€ ä¸å›å…±å‹‰ï¼</p>
    """
    
    return {"subject": subject, "html": content}


# ===================================================================================
# æ­¥éª¤ 3: åœ¨è¿™é‡Œæ³¨å†Œæ‰€æœ‰ä½ è‡ªå®šä¹‰çš„æ¨¡æ¿
# ===================================================================================
# å­—å…¸çš„ `key` æ˜¯æ¨¡æ¿çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå»ºè®®ä½¿ç”¨è›‡å½¢å‘½åæ³• (snake_case)ã€‚
# è¿™ä¸ª `key` å°†è¢«ç”¨äº API è°ƒç”¨ã€‚
# å­—å…¸çš„ `value` æ˜¯ä¸€ä¸ªåŒ…å«å…ƒæ•°æ®å’Œç”Ÿæˆå‡½æ•°çš„å­—å…¸ã€‚

custom_templates = {
    "monthly_learning_report": {
        "meta": monthly_learning_report_meta,
        "func": get_monthly_learning_report_template
    },
    # å¦‚æœä½ åˆ›å»ºäº†ç¬¬äºŒä¸ªæ¨¡æ¿ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·ç»§ç»­æ·»åŠ :
    # "my_second_template": {
    #     "meta": my_second_template_meta,
    #     "func": get_my_second_template_func
    # }
}